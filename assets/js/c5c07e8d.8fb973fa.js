"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[6010],{97990:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"backgroundservice","title":"Background Service","description":"In order to perform certificate requests and automatic renewals we install a background service called \\"Certify.Service\\" or \\"Certify.Server.Core\\" (the full title is either Certify Certificate Manager Service or Certify Management Agent for v7 onwards).","source":"@site/docs/backgroundservice.md","sourceDirName":".","slug":"/backgroundservice","permalink":"/docs/backgroundservice","draft":false,"unlisted":false,"editUrl":"https://github.com/webprofusion/certify-docs/edit/master/docs/backgroundservice.md","tags":[],"version":"current","frontMatter":{"id":"backgroundservice","title":"Background Service"},"sidebar":"docSidebar","previous":{"title":"Best Practices","permalink":"/docs/guides/best-practices"},"next":{"title":"Using Certificates in Windows","permalink":"/docs/guides/ssl-windows"}}');var r=n(74848),i=n(28453);const o={id:"backgroundservice",title:"Background Service"},a=void 0,c={},d=[{value:"Custom configuration and Troubleshooting &quot;..service not started&quot; error",id:"custom-configuration-and-troubleshooting-service-not-started-error",level:2},{value:"Other Considerations for &#39;Service Not Started..&#39;",id:"other-considerations-for-service-not-started",level:3},{value:"Enable http listener IP address",id:"enable-http-listener-ip-address",level:4},{value:"Allow Local System account to bind an http listener to the service port",id:"allow-local-system-account-to-bind-an-http-listener-to-the-service-port",level:4},{value:"Managed Items Database",id:"managed-items-database",level:2},{value:"Data Recovery",id:"data-recovery",level:3},{value:"Attempt an export",id:"attempt-an-export",level:3},{value:"Attempt a recovery using SQL dump",id:"attempt-a-recovery-using-sql-dump",level:3}];function l(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(t.p,{children:['In order to perform certificate requests and automatic renewals we install a background service called "Certify.Service" or "Certify.Server.Core" (the full title is either ',(0,r.jsx)(t.code,{children:"Certify Certificate Manager Service"})," or ",(0,r.jsx)(t.code,{children:"Certify Management Agent"})," for v7 onwards)."]}),"\n",(0,r.jsxs)(t.p,{children:["This service is installed to run as Local System and requires that the Local System account has the necessary privileges to administer IIS (if required) and the computers certificate store, as well as writing to the C:\\ProgramData\\Certify folder for configuration information. For more information on security and required permissions see ",(0,r.jsx)(t.a,{href:"/docs/guides/security",children:"security"})]}),"\n",(0,r.jsxs)(t.p,{children:["To check the log for this service, review ",(0,r.jsx)(t.code,{children:"C:\\ProgramData\\Certify\\logs\\service.exceptions.log"}),"."]}),"\n",(0,r.jsx)(t.h2,{id:"custom-configuration-and-troubleshooting-service-not-started-error",children:'Custom configuration and Troubleshooting "..service not started" error'}),"\n",(0,r.jsxs)(t.p,{children:["By default the background service runs a local http API server on port ",(0,r.jsx)(t.code,{children:"9696"})," for the UI to talk to (bound to local loopback ",(0,r.jsx)(t.code,{children:"127.0.0.2"})," and requiring windows authentication). ",(0,r.jsx)(t.em,{children:"Do not open this service to external traffic on your firewall."})]}),"\n",(0,r.jsxs)(t.p,{children:["If this port is in use by another application/service or for some other reason the service cannot create/use a binding to ",(0,r.jsx)(t.code,{children:"127.0.0.2:9696"})," (localhost), or a security product is preventing ",(0,r.jsx)(t.strong,{children:"local"})," port access) then you will see the message ",(0,r.jsx)(t.strong,{children:"'Service not started'"}),"."]}),"\n",(0,r.jsxs)(t.admonition,{type:"info",children:[(0,r.jsxs)(t.p,{children:['If you are repeatedly seeing the "Service Not Started" error, first try deleting ',(0,r.jsx)(t.code,{children:"serviceconfig.json"})," and ",(0,r.jsx)(t.code,{children:"servers.json"})," from C:\\ProgramData\\Certify\\ then restart the background service and the app and these config files will be recreated. This can help if automatic port negotiation has gotten out of sync."]}),(0,r.jsxs)(t.p,{children:["In some cases antivirus software products (such as ",(0,r.jsx)(t.em,{children:"ClamWin"}),", ",(0,r.jsx)(t.em,{children:"Watchguard Advanced EPDR"}),", ",(0,r.jsx)(t.em,{children:"ESET"}),") have been known to prevent the Certify service installing properly or can prevent some core features working like our temporary http challenge service listener."]})]}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"servers.json"})," : This is the connection information used by the UI to connect to the background service."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"serviceconfig.json"})," : These are the service settings and includes the host/ip and port the service will listen on, so it needs to match the details in ",(0,r.jsx)(t.code,{children:"servers.json"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:["If the default port 9696 is already in use you can manually specify the settings required by editing/adding the file ",(0,r.jsx)(t.code,{children:"c:\\programdata\\certify\\serviceconfig.json"})," (and servers.json) with content as per the following (adjusted as required) then restarting both the service and UI:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-json",children:'{\n  "host": "localhost",\n  "port": 9696\n}\n'})}),"\n",(0,r.jsxs)(t.p,{children:["Any local IP, loopback address (or ",(0,r.jsx)(t.code,{children:"localhost"}),") can be used, local loopback addresses are strongly recommended (ip range 127.*) so that remote access is not possible."]}),"\n",(0,r.jsx)(t.p,{children:"For example an alternative configuration might be:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-json",children:'{\n  "host": "127.0.0.1",\n  "port": 9695\n}\n'})}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsxs)(t.em,{children:["You will also need to update corresponding configuration in the ",(0,r.jsx)(t.code,{children:"servers.json"})," file (which the UI refers to in order to locate the service)."]})}),"\n",(0,r.jsxs)(t.p,{children:["To test that the reconfigured service is communicating OK, you can try opening the following URL in your browser:\n",(0,r.jsx)(t.code,{children:"http://localhost:9695/api/system/appversion"})," where 'localhost' is your configured service ",(0,r.jsx)(t.code,{children:"host"})," value and ",(0,r.jsx)(t.code,{children:"9695"})," is an example configured port."]}),"\n",(0,r.jsx)(t.p,{children:"You can also try the same using PowerShell:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-ps",children:"Invoke-RestMethod -Uri http://localhost:9696/api/system/appversion -UseDefaultCredentials\n"})}),"\n",(0,r.jsx)(t.h3,{id:"other-considerations-for-service-not-started",children:"Other Considerations for 'Service Not Started..'"}),"\n",(0,r.jsx)(t.p,{children:"To operate properly the background service needs to be able to register an http listener for it's API server via http.sys, for that to work the IP address the service tries to use must be enabled as an http listen address and in some versions of windows the Http kernel service may not be enabled and you will need to enable it."}),"\n",(0,r.jsx)(t.h4,{id:"enable-http-listener-ip-address",children:"Enable http listener IP address"}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.strong,{children:"You do not normally have to configure any netsh iplisten rules, unless your system already has retrictions in place."})}),"\n",(0,r.jsx)(t.p,{children:"If your system is restricting which IP addresses can listen for HTTP traffic you may find you need to enable iplisten for the service IP."}),"\n",(0,r.jsxs)(t.p,{children:["As per ",(0,r.jsx)(t.a,{href:"https://docs.microsoft.com/en-us/windows/win32/http/add-iplisten",children:"https://docs.microsoft.com/en-us/windows/win32/http/add-iplisten"})," enable any IPv4 address to listen for http. :"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bat",children:"netsh http add iplisten ipaddress=0.0.0.0\n"})}),"\n",(0,r.jsx)(t.p,{children:"or Add IP listen on the local IPv6 address:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bat",children:"netsh http add iplisten ipaddress=::\n"})}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.strong,{children:"Or to target a specific IP address such as 127.0.0.2 (our default local loopback IP setting)"}),":"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bat",children:"netsh http add iplisten ipaddress=127.0.0.2\n"})}),"\n",(0,r.jsx)(t.p,{children:"You should monitor other effects on other services when changing the IP listen configuration. We have seen one report of Exchange/Outlook slowing down when the 0.0.0.0 address iplisten is enabled."}),"\n",(0,r.jsx)(t.admonition,{type:"info",children:(0,r.jsxs)(t.p,{children:["Check your current system IP listener rules using ",(0,r.jsx)(t.code,{children:"netsh show iplisten"}),". If you have any IP listen rules ",(0,r.jsx)(t.em,{children:"already configured"})," not using the catch-all ",(0,r.jsx)(t.code,{children:"0.0.0.0"})," IP then your system will not listen on the default 127.0.0.2 IP and you will need to run ",(0,r.jsx)(t.code,{children:"netsh http add iplisten ipaddress=127.0.0.2"})," to allow the service listener to work."]})}),"\n",(0,r.jsx)(t.h4,{id:"allow-local-system-account-to-bind-an-http-listener-to-the-service-port",children:"Allow Local System account to bind an http listener to the service port"}),"\n",(0,r.jsx)(t.p,{children:"In some cases you need to explicitly allow the service to listen as an http service on the localhost IP address. To do so run the following command from the command line as an Administrator, substituting your choice of listening IP address and port:"}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.code,{children:'netsh http add urlacl url=http://127.0.0.2:9696/ user="NT AUTHORITY\\SYSTEM"'})}),"\n",(0,r.jsxs)(t.p,{children:["By default the windows http service is typically enabled but if you receive the error 'Operation is not supported on this platform' in ",(0,r.jsx)(t.code,{children:"service.exceptions.log"})," then try checking the status of the windows http service. To do so, run the following from an elevated command prompt (using Run As Administrator):"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bat",children:"sc query http\n"})}),"\n",(0,r.jsx)(t.p,{children:"This should produce output like:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bat",children:"SERVICE_NAME: http\n        TYPE               : 1  KERNEL_DRIVER\n        STATE              : 4  RUNNING\n                                (STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)\n        WIN32_EXIT_CODE    : 0  (0x0)\n        SERVICE_EXIT_CODE  : 0  (0x0)\n        CHECKPOINT         : 0x0\n        WAIT_HINT          : 0x0\n\n"})}),"\n",(0,r.jsxs)(t.p,{children:["If the state is not ",(0,r.jsx)(t.code,{children:"RUNNING"})," use the following command the enable the service on demand:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bat",children:"sc config http start= demand\n"})}),"\n",(0,r.jsx)(t.p,{children:"Then start the http service"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bat",children:"net start http\n"})}),"\n",(0,r.jsxs)(t.p,{children:["If the service remains at ",(0,r.jsx)(t.code,{children:"STOPPING"})," or similar then a system reboot may be required."]}),"\n",(0,r.jsx)(t.p,{children:"Once completed, restart the Certify background service from local services, then open the Certify Certificate Manager UI again to see if it can connect."}),"\n",(0,r.jsx)(t.h2,{id:"managed-items-database",children:"Managed Items Database"}),"\n",(0,r.jsx)(t.p,{children:"The data store for the managed certificates database is the C:\\ProgramData\\Certify\\manageditems.db SQLite database. This stores your renewal configuration data (not certificates). This is an sqlite3 format database files."}),"\n",(0,r.jsxs)(t.p,{children:["You should include C:\\ProgramData\\Certify\\ in your normal backup procedures, otherwise if you lose this configuration or it is corrupted you may need to add all of your managed certificates again. ",(0,r.jsx)(t.strong,{children:"To guard against database corruption you should add an exclusion to your anti-virus software to avoid sharing conflicts."})]}),"\n",(0,r.jsx)(t.p,{children:"On service startup and on a daily schedule the system will make a copy of manageditems.db called manageditems.db.bak."}),"\n",(0,r.jsx)(t.h3,{id:"data-recovery",children:"Data Recovery"}),"\n",(0,r.jsx)(t.p,{children:"Storage write errors or sudden unexpected system shutdowns can (in rare occasions) cause database corruption. In the event that your database (and backup) become corrupted the sqlite tools may be used to recover some or all of the information."}),"\n",(0,r.jsx)(t.h3,{id:"attempt-an-export",children:"Attempt an export"}),"\n",(0,r.jsx)(t.p,{children:"The following will copy the contents of manageditems.db to a new db file. You can try this in place of your original:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"sqlite3.exe manageditems.db\nsqlite> .backup output.db\n"})}),"\n",(0,r.jsx)(t.p,{children:"Then copy new.db to manageditems.db and start the Certify service."}),"\n",(0,r.jsx)(t.h3,{id:"attempt-a-recovery-using-sql-dump",children:"Attempt a recovery using SQL dump"}),"\n",(0,r.jsxs)(t.p,{children:["Based on the example from ",(0,r.jsx)(t.a,{href:"https://ronnieroller.com/Repair-an-SQLite-database",children:"https://ronnieroller.com/Repair-an-SQLite-database"})," we can export the database"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"sqlite3 manageditems-corrupted.db\nsqlite> .mode insert\nsqlite> .output dump.sql\nsqlite> .dump\nsqlite3.exe new.db < dump.sql\n"})}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:'sqlite3 new.db "PRAGMA integrity_check"\n'})}),"\n",(0,r.jsx)(t.p,{children:"Then copy new.db to manageditems.db and start the Certify service."})]})}function h(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>a});var s=n(96540);const r={},i=s.createContext(r);function o(e){const t=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),s.createElement(i.Provider,{value:t},e.children)}}}]);